(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();function A(t){const e=v(t,l.__wbindgen_malloc,l.__wbindgen_realloc),n=g,i=l.compile_song(e,n);if(i[2])throw E(i[1]);return E(i[0])}function B(){return{__proto__:null,"./songwalker_core_bg.js":{__proto__:null,__wbg_String_8f0eb39a4a4c2f66:function(e,n){const i=String(n),s=v(i,l.__wbindgen_malloc,l.__wbindgen_realloc),o=g;w().setInt32(e+4,o,!0),w().setInt32(e+0,s,!0)},__wbg___wbindgen_throw_be289d5034ed271b:function(e,n){throw new Error(_(e,n))},__wbg_new_361308b2356cecd0:function(){return new Object},__wbg_new_3eb36ae241fe6f44:function(){return new Array},__wbg_set_3f1d0b984ed272ed:function(e,n,i){e[n]=i},__wbg_set_f43e577aea94465b:function(e,n,i){e[n>>>0]=i},__wbindgen_cast_0000000000000001:function(e){return e},__wbindgen_cast_0000000000000002:function(e,n){return _(e,n)},__wbindgen_init_externref_table:function(){const e=l.__wbindgen_externrefs,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)}}}}let f=null;function w(){return(f===null||f.buffer.detached===!0||f.buffer.detached===void 0&&f.buffer!==l.memory.buffer)&&(f=new DataView(l.memory.buffer)),f}function _(t,e){return t=t>>>0,I(t,e)}let d=null;function m(){return(d===null||d.byteLength===0)&&(d=new Uint8Array(l.memory.buffer)),d}function v(t,e,n){if(n===void 0){const a=h.encode(t),u=e(a.length,1)>>>0;return m().subarray(u,u+a.length).set(a),g=a.length,u}let i=t.length,s=e(i,1)>>>0;const o=m();let r=0;for(;r<i;r++){const a=t.charCodeAt(r);if(a>127)break;o[s+r]=a}if(r!==i){r!==0&&(t=t.slice(r)),s=n(s,i,i=r+t.length*3,1)>>>0;const a=m().subarray(s+r,s+i),u=h.encodeInto(t,a);r+=u.written,s=n(s,i,r,1)>>>0}return g=r,s}function E(t){const e=l.__wbindgen_externrefs.get(t);return l.__externref_table_dealloc(t),e}let p=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});p.decode();const L=2146435072;let b=0;function I(t,e){return b+=e,b>=L&&(p=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),p.decode(),b=e),p.decode(m().subarray(t,t+e))}const h=new TextEncoder;"encodeInto"in h||(h.encodeInto=function(t,e){const n=h.encode(t);return e.set(n),{read:t.length,written:n.length}});let g=0,l;function k(t,e){return l=t.exports,f=null,d=null,l.__wbindgen_start(),l}async function O(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(s){if(t.ok&&n(t.type)&&t.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",s);else throw s}const i=await t.arrayBuffer();return await WebAssembly.instantiate(i,e)}else{const i=await WebAssembly.instantiate(t,e);return i instanceof WebAssembly.Instance?{instance:i,module:t}:i}function n(i){switch(i){case"basic":case"cors":case"default":return!0}return!1}}async function C(t){if(l!==void 0)return l;t!==void 0&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),t===void 0&&(t=new URL("/assets/songwalker_core_bg-sLpi97PR.wasm",import.meta.url));const e=B();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:i}=await O(await t,e);return k(n)}const M={C:0,D:2,E:4,F:5,G:7,A:9,B:11};function P(t){const e=t.match(/^([A-G])(b|#)?(\d+)$/);if(!e)return null;const[,n,i,s]=e,o=parseInt(s,10);let r=M[n];if(r===void 0)return null;i==="#"?r+=1:i==="b"&&(r-=1);const a=(o+1)*12+r;return 440*Math.pow(2,(a-69)/12)}class R{ctx=null;events=[];totalBeats=0;bpm=120;startTime=0;nextEventIndex=0;schedulerTimer=null;stateTimer=null;playing=!1;onStateChange=null;LOOKAHEAD_SEC=.15;SCHEDULE_INTERVAL_MS=50;constructor(){}load(e){this.stop(),this.events=e.events,this.totalBeats=e.total_beats,this.nextEventIndex=0;for(const n of this.events)if("SetProperty"in n.kind){const i=n.kind.SetProperty;i.target==="track.beatsPerMinute"&&(this.bpm=parseFloat(i.value)||120)}this.emitState()}onState(e){this.onStateChange=e}async play(){this.playing||(this.ctx||(this.ctx=new AudioContext),this.ctx.state==="suspended"&&await this.ctx.resume(),this.playing=!0,this.nextEventIndex=0,this.startTime=this.ctx.currentTime,this.schedulerLoop(),this.stateTimer=window.setInterval(()=>this.emitState(),50),this.emitState())}stop(){this.playing=!1,this.schedulerTimer!==null&&(clearTimeout(this.schedulerTimer),this.schedulerTimer=null),this.stateTimer!==null&&(clearInterval(this.stateTimer),this.stateTimer=null),this.nextEventIndex=0,this.emitState()}getCurrentBeat(){return!this.playing||!this.ctx?0:(this.ctx.currentTime-this.startTime)*this.bpm/60}schedulerLoop(){if(!this.playing||!this.ctx)return;const e=this.ctx.currentTime,n=e+this.LOOKAHEAD_SEC;for(;this.nextEventIndex<this.events.length;){const s=this.events[this.nextEventIndex],o=this.startTime+s.time*60/this.bpm;if(o>n)break;this.scheduleEvent(s,o),this.nextEventIndex++}const i=this.startTime+this.totalBeats*60/this.bpm;if(e>=i){this.stop();return}this.schedulerTimer=window.setTimeout(()=>this.schedulerLoop(),this.SCHEDULE_INTERVAL_MS)}scheduleEvent(e,n){if(this.ctx&&"Note"in e.kind){const i=e.kind.Note;this.scheduleNote(i,n)}}scheduleNote(e,n){if(!this.ctx)return;const i=P(e.pitch);if(i===null)return;const s=e.duration*60/this.bpm,o=Math.min(e.velocity/127,1),r=this.ctx.createOscillator(),a=this.ctx.createGain();r.type="triangle",r.frequency.setValueAtTime(i,n),a.gain.setValueAtTime(o*.3,n),a.gain.exponentialRampToValueAtTime(.001,n+s),r.connect(a),a.connect(this.ctx.destination),r.start(n),r.stop(n+s+.05)}emitState(){this.onStateChange&&this.onStateChange({playing:this.playing,currentBeat:this.getCurrentBeat(),totalBeats:this.totalBeats,bpm:this.bpm})}}const F=`// SongWalker Example
const lead = await loadPreset("Oscillator");
track.beatsPerMinute = 140;

riff();

track riff() {
    track.duration = 1/4;

    C4 /4
    E4 /4
    G4 /4
    C5 /2

    B4 /4
    G4 /4
    E4 /4
    C4 /2

    4
}
`,S="songwalker_source";function D(){return localStorage.getItem(S)||F}function x(t){localStorage.setItem(S,t)}function T(){return"showOpenFilePicker"in window}async function W(){if(T())try{const[t]=await window.showOpenFilePicker({types:[{description:"SongWalker files",accept:{"text/plain":[".sw"]}}]});return await(await t.getFile()).text()}catch{return null}else return new Promise(t=>{const e=document.createElement("input");e.type="file",e.accept=".sw,.txt",e.onchange=async()=>{const n=e.files?.[0];t(n?await n.text():null)},e.click()})}async function N(t){if(T())try{const n=await(await window.showSaveFilePicker({suggestedName:"song.sw",types:[{description:"SongWalker files",accept:{"text/plain":[".sw"]}}]})).createWritable();await n.write(t),await n.close()}catch{}else{const e=new Blob([t],{type:"text/plain"}),n=URL.createObjectURL(e),i=document.createElement("a");i.href=n,i.download="song.sw",i.click(),URL.revokeObjectURL(n)}}async function U(){await C();const t=new R,e=document.getElementById("editor"),n=document.getElementById("play-btn"),i=document.getElementById("stop-btn"),s=document.getElementById("open-btn"),o=document.getElementById("save-btn"),r=document.getElementById("fullscreen-btn"),a=document.getElementById("status"),u=document.getElementById("error");e.value=D(),e.addEventListener("input",()=>{x(e.value)});function y(){u.textContent="";try{const c=A(e.value);t.load(c),t.play()}catch(c){u.textContent=String(c)}}n.addEventListener("click",y),i.addEventListener("click",()=>t.stop()),s.addEventListener("click",async()=>{const c=await W();c!==null&&(e.value=c,x(c))}),o.addEventListener("click",()=>N(e.value)),r.addEventListener("click",()=>{document.documentElement.classList.toggle("fullscreen")}),document.addEventListener("keydown",c=>{(c.ctrlKey||c.metaKey)&&c.key==="Enter"&&(c.preventDefault(),y()),c.key==="Escape"&&document.documentElement.classList.remove("fullscreen")}),t.onState(c=>{c.playing?a.textContent=`Playing: beat ${c.currentBeat.toFixed(1)} / ${c.totalBeats.toFixed(1)} @ ${c.bpm} BPM`:a.textContent=`Stopped | ${c.totalBeats.toFixed(1)} beats @ ${c.bpm} BPM`})}U().catch(console.error);
